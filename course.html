<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Curso</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.04);
      --stroke:rgba(148,163,184,.22);
      --text:#f9fafb;
      --muted:rgba(255,255,255,.70);
      --green:#22c55e;
      --blue:#38bdf8;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
    a{color:inherit}

    header{
      position:sticky;top:0;z-index:20;
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      background:linear-gradient(180deg, rgba(11,18,32,.96), rgba(11,18,32,.86));
      backdrop-filter: blur(8px);
      display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;
    }
    #courseTitle{font-weight:1000;font-size:20px;}
    .muted{color:var(--muted)}

    .top-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .topbtn{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;text-decoration:none;font-weight:900;
      border:1px solid transparent;
    }
    .secondary{background:rgba(56,189,248,.18);border-color:rgba(56,189,248,.35)}
    .primary{background:var(--green);color:#071018;border:0;cursor:pointer}

    .container{max-width:1080px;margin:0 auto;padding:14px 14px 28px}
    .player-wrap{
      border:1px solid var(--stroke);
      border-radius:18px;
      overflow:hidden;
      background:var(--panel2);
      box-shadow:0 18px 40px rgba(0,0,0,.35);
      position:relative;
    }
    .player{
      position:relative;
      width:100%;
      padding-top:56.25%;
      background:rgba(0,0,0,.25);
    }
    iframe{position:absolute;inset:0;width:100%;height:100%}

    .player-meta{
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
      padding:12px 12px 12px;
      border-top:1px solid var(--stroke);
    }
    .player-meta .left{min-width:0;margin-top:22px !important;}
    .player-meta .left .now{font-weight:900}
    .player-meta .right{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}

    .curriculum{
      margin-top:14px;
      border:1px solid var(--stroke);
      border-radius:18px;
      overflow:hidden;
      background:var(--panel2);
    }
    .curriculum-h{
      padding:14px 14px;
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      border-bottom:1px solid var(--stroke);
      background:rgba(255,255,255,.03);
    }
    .curriculum-h h2{margin:0;font-size:16px;letter-spacing:.2px}
    .curriculum-h .sub{font-size:12px;color:var(--muted)}
    #modules{display:flex;flex-direction:column}

    .mod{
      width:100%;
      text-align:left;
      display:flex;gap:12px;align-items:center;
      padding:12px 14px;
      border:0;
      background:transparent;
      color:inherit;
      cursor:pointer;
      border-bottom:1px solid rgba(148,163,184,.18);
    }
    .mod:last-child{border-bottom:0}
    .mod:hover{background:rgba(255,255,255,.04)}
    .mod.active{background:rgba(34,197,94,.10)}
    .mod .thumb{
      width:84px;aspect-ratio:16/9;border-radius:12px;overflow:hidden;
      background:rgba(0,0,0,.35);flex:0 0 auto;
      border:1px solid rgba(255,255,255,.10);
    }
    .mod .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .mod .info{min-width:0;flex:1}
    .mod .info .t{margin:0;font-weight:900;font-size:14px;line-height:1.2}
    .mod .info .s{margin:6px 0 0;font-size:12px;color:var(--muted)}
    .err{color:#fca5a5;font-weight:800;white-space:pre-wrap;padding:12px 14px}

    @media (max-width: 520px){
      header{padding:12px 12px}
      .container{padding:12px 12px 24px}
      .mod .thumb{width:74px}
    }
    @media (min-width: 900px){
      .container{
        display:grid;
        grid-template-columns: 1.45fr 1fr;
        gap:14px;
        align-items:start;
      }
      .curriculum{margin-top:0; max-height: calc(100vh - 94px); overflow:auto}
    }
    @media (orientation: landscape) and (max-height: 520px){
      .container{padding:10px 10px 18px}
      .player{padding-top:0;height: calc(100vh - 150px);}
      iframe{height:100%}
      .curriculum{max-height: calc(100vh - 94px); overflow:auto}
    }

    .user-menu{position:relative}
    .user-trigger{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:inherit;font-weight:900;cursor:pointer;
    }
    .avatar{display:inline-flex;width:26px;height:26px;align-items:center;justify-content:center;
      border-radius:999px;background:rgba(56,189,248,.18);border:1px solid rgba(56,189,248,.30)}
    .caret{opacity:.85}
    .user-dropdown{
      z-index:50;
      position:absolute;right:0;top:calc(100% + 10px);
      min-width:210px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(15,23,42,.96);
      backdrop-filter: blur(10px);
      border-radius:14px;
      box-shadow:0 24px 60px rgba(0,0,0,.45);
      padding:8px;
      display:none;
    }
    .user-dropdown.open{display:block}
    .dd-item{
      width:100%;
      display:flex;align-items:center;gap:10px;
      padding:10px 10px;border-radius:12px;
      text-decoration:none;
      border:0;background:transparent;color:inherit;
      font-weight:900;cursor:pointer;text-align:left;
    }
    .dd-item:hover{background:rgba(255,255,255,.06)}
    .dd-sep{height:1px;background:rgba(148,163,184,.18);margin:6px 4px}
    .dd-item.danger{color:#fecaca}

    /* Controles custom */
    .yt-player{position:absolute; inset:0; width:100%; height:100%;}
    .cc-wrap{display:flex; gap:10px; align-items:center; flex-wrap:nowrap;}
    .cc-btn{
      width:44px; height:38px;
      border:0; border-radius:12px;
      background:rgba(255,255,255,.10);
      color:#fff; font-size:18px;
    }
    .cc-seek{ flex:1; min-width: 120px; }
    .cc-time{ font-variant-numeric: tabular-nums; opacity:.85; font-size: 13px; white-space: nowrap; }
    .cc-speed{ width:56px !important; font-size:14px !important; }

    .tap-shield{
      position:absolute;left:0;top:0;right:0;height:100%;
      z-index:50;background:transparent;pointer-events:auto;
    }
    #ccWrap{
      position:absolute !important;
      left:12px; right:12px; bottom:28px;
      z-index:60;
      opacity:0; transform: translateY(8px);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    #ccWrap.is-visible{
      opacity:1; transform: translateY(0);
      pointer-events:auto;
    }
    #openYT{display:none !important;}
  </style>
</head>

<body>
  <header>
    <div>
      <div id="courseTitle">Cargando‚Ä¶</div>
      <div id="nowPlaying" class="muted"></div>
    </div>

    <div class="top-actions">
      <a class="topbtn secondary" href="account.html">‚¨Ö Mis cursos</a>

      <div class="user-menu" id="userMenu" style="display:none;">
        <button class="user-trigger" id="userTrigger" aria-haspopup="menu" aria-expanded="false">
          <span class="avatar" aria-hidden="true">üë§</span>
          <span id="userName">Cargando‚Ä¶</span>
          <span class="caret" aria-hidden="true">‚ñæ</span>
        </button>

        <div class="user-dropdown" id="userDropdown" role="menu">
          <a class="dd-item" href="account.html" role="menuitem">üìö Mis cursos</a>
          <a class="dd-item" href="account.html" role="menuitem">üë§ Mi perfil</a>
          <div class="dd-sep"></div>
          <button class="dd-item danger" id="logout" role="menuitem">üö™ Cerrar sesi√≥n</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <section class="player-wrap" aria-label="Reproductor">
      <div class="player">
        <div id="player" class="yt-player"></div>
        <div id="tapShield" class="tap-shield" aria-label="Zona protegida del video"></div>

        <div class="cc-wrap" id="ccWrap" aria-label="Controles del video">
          <button class="cc-btn" id="ccPlay" type="button" aria-label="Reproducir / Pausar">‚ñ∂</button>
          <input class="cc-seek" id="ccSeek" type="range" min="0" max="1000" value="0" aria-label="L√≠nea de tiempo">
          <span class="cc-time" id="ccTime">0:00 / 0:00</span>
          <button class="cc-btn cc-speed" id="ccSpeedBtn" type="button" aria-label="Velocidad">1x</button>
          <button class="cc-btn" id="ccFs" type="button" aria-label="Pantalla completa">‚õ∂</button>
        </div>
      </div>

      <div class="player-meta">
        <div class="left">
          <div class="now" id="nowTitle">Reproduciendo</div>
        </div>
        <div class="right">
          <a class="smallbtn" id="openYT" href="#" target="_blank" rel="noopener">Ver en YouTube</a>
        </div>
      </div>
    </section>

    <section class="curriculum" aria-label="M√≥dulos">
      <div class="curriculum-h">
        <div>
          <h2>M√≥dulos</h2>
          <div class="sub">Selecciona una clase para reproducir</div>
        </div>
        <div class="sub" id="countMods"></div>
      </div>

      <div id="modules"></div>
      <div id="msg" class="err"></div>
    </section>
  </div>

  <script>
    /* ===== YouTube IFrame Player API + controles propios ===== */
    let YTPlayer = null;
    let YTReady = false;
    let pendingVideoId = null;

    function fmtTime_(sec){
      sec = Math.max(0, Math.floor(sec || 0));
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return m + ":" + String(s).padStart(2, "0");
    }

    function normalizeVideoId_(value){
      if (!value) return "";
      const v = String(value).trim();
      if (/^[a-zA-Z0-9_-]{11}$/.test(v)) return v;
      const m = v.match(/(?:youtu\.be\/|v=|\/embed\/)([a-zA-Z0-9_-]{11})/);
      return m ? m[1] : "";
    }

    function ensureYT_(){
      if (document.getElementById("ytApiLoaded")) return;
      const s = document.createElement("script");
      s.id = "ytApiLoaded";
      s.src = "https://www.youtube.com/iframe_api";
      s.async = true;
      document.head.appendChild(s);
    }

    function loadVideoById_(videoId, autoplay){
      const vid = normalizeVideoId_(videoId);
      if (!vid) return;
      if (YTReady && YTPlayer && typeof YTPlayer.loadVideoById === "function"){
        YTPlayer.loadVideoById({ videoId: vid, startSeconds: 0 });
        if (autoplay) YTPlayer.playVideo();
      } else {
        pendingVideoId = vid;
      }
    }

    function setupControls_(){
      const btn = document.getElementById("ccPlay");
      const seek = document.getElementById("ccSeek");
      const time = document.getElementById("ccTime");
      const fs = document.getElementById("ccFs");
      const wrap = document.querySelector(".player-wrap");
      let seeking = false;

      const speedBtn = document.getElementById("ccSpeedBtn");
      const speedRates = [0.5, 0.75, 1, 1.25, 1.5, 2];
      let speedIdx = 2;

      function applySpeed_(){
        if (!YTPlayer) return;
        const r = speedRates[speedIdx] || 1;
        try{ YTPlayer.setPlaybackRate(r); }catch(e){}
        if (speedBtn) speedBtn.textContent = (r % 1 === 0 ? String(r).replace('.0','') : String(r)) + "x";
      }

      if (speedBtn){
        speedBtn.addEventListener("click", () => {
          speedIdx = (speedIdx + 1) % speedRates.length;
          applySpeed_();
        });
      }

      if (btn){
        btn.addEventListener("click", () => {
          if (!YTPlayer) return;
          const st = YTPlayer.getPlayerState();
          if (st === 1) YTPlayer.pauseVideo();
          else YTPlayer.playVideo();
        });
      }

      if (seek){
        seek.addEventListener("input", () => { seeking = true; });
        seek.addEventListener("change", () => {
          if (!YTPlayer) return;
          const dur = YTPlayer.getDuration ? YTPlayer.getDuration() : 0;
          const v = Number(seek.value || 0) / 1000;
          if (dur > 0) YTPlayer.seekTo(dur * v, true);
          seeking = false;
        });
      }

      async function toggleFs(){
        if (!wrap) return;
        try{
          const isFs = document.fullscreenElement || document.webkitFullscreenElement;
          if (isFs){
            if (document.exitFullscreen) await document.exitFullscreen();
            else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
          } else {
            if (wrap.requestFullscreen) await wrap.requestFullscreen();
            else if (wrap.webkitRequestFullscreen) await wrap.webkitRequestFullscreen();
          }
        }catch(e){}
      }
      if (fs) fs.addEventListener("click", toggleFs);

      setInterval(() => {
        if (!YTPlayer) return;
        if (seek && !seeking){
          const dur = YTPlayer.getDuration ? YTPlayer.getDuration() : 0;
          const cur = YTPlayer.getCurrentTime ? YTPlayer.getCurrentTime() : 0;
          if (dur > 0){
            seek.value = String(Math.round((cur / dur) * 1000));
            if (time) time.textContent = fmtTime_(cur) + " / " + fmtTime_(dur);
          }
        }
      }, 500);
    }

    window.onYouTubeIframeAPIReady = function(){
      YTReady = true;

      YTPlayer = new YT.Player("player", {
        width: "100%",
        height: "100%",
        playerVars: {
          controls: 0,
          rel: 0,
          modestbranding: 1,
          iv_load_policy: 3,
          playsinline: 1,
          disablekb: 1,
          fs: 0
        },
        events: {
          onReady: () => {
            setupControls_();
            if (pendingVideoId){
              loadVideoById_(pendingVideoId, false);
              pendingVideoId = null;
            }
          },
          onStateChange: (e) => {
            const btn = document.getElementById("ccPlay");
            if (!btn) return;
            btn.textContent = (e.data === 1) ? "‚è∏" : "‚ñ∂";
          }
        }
      });
    };

    ensureYT_();
  </script>

  <script>
    function escapeHtml_(s){
      return String(s||"").replace(/[&<>"']/g,(c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
    }

    // ‚úÖ TU PROXY DE ELIANE
    const API_URL = "https://eliane-beautys-proxy-4wlw.vercel.app/api";

    function jsonp(action, payload) {
      return new Promise((resolve, reject) => {
        const cb = "cb_" + Math.random().toString(36).slice(2);
        const params = new URLSearchParams();
        params.set("action", action);
        Object.entries(payload || {}).forEach(([k,v]) => {
          if (v === undefined || v === null) return;
          params.set(k, String(v));
        });
        params.set("callback", cb);

        const script = document.createElement("script");
        script.src = API_URL + "?" + params.toString();
        script.async = true;

        window[cb] = (data) => { cleanup(); resolve(data); };

        function cleanup() {
          try { delete window[cb]; } catch(e) { window[cb] = undefined; }
          if (script.parentNode) script.parentNode.removeChild(script);
        }

        script.onerror = () => { cleanup(); reject(new Error("No se pudo conectar (JSONP).")); };

        document.body.appendChild(script);
      });
    }

    const token = sessionStorage.getItem("pasir_token");
    if (!token) location.href = "login.html";

    const params = new URLSearchParams(location.search);
    const courseId = params.get("courseId");

    document.getElementById("logout").onclick = () => {
      sessionStorage.removeItem("pasir_token");
      sessionStorage.removeItem("pasir_email");
      location.href = "index.html";
    };

    function setActive(btn) {
      document.querySelectorAll(".mod").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    }
    function showError(text) {
      document.getElementById("msg").textContent = text || "";
    }

    function pickModuleTitle_(m){
      return (m && (m.title || m.moduleTitle || m.moduloTitle || m.nombre || "")) || "";
    }
    function pickModuleOrder_(m, idx){
      const v = (m && (m.order ?? m.orden ?? m.nro ?? m.numero));
      return (v !== undefined && v !== null && String(v).trim() !== "") ? v : (idx + 1);
    }
    function pickVideoId_(m){
      return (m && (m.videoId || m.videoid || m.video || "")) || "";
    }

    (async () => {
      if (!courseId) {
        showError("Falta courseId en la URL. Ej: course.html?courseId=logo8-basico");
        return;
      }

      const r = await jsonp("course", { token, courseId });
      if (!r.ok) {
        showError(r.error || "No se pudo cargar el curso.");
        if ((r.error || "").toLowerCase().includes("no autorizado")) {
          setTimeout(()=> location.href="account.html", 800);
        }
        return;
      }

      // ‚úÖ Soporta: r.courseTitle (tu API) y fallback
      const courseTitle =
        r.courseTitle ||
        (r.course && (r.course.title || r.course.courseTitle)) ||
        courseId;

      document.getElementById("courseTitle").textContent = courseTitle;

      const mods = Array.isArray(r.modules) ? r.modules : [];
      document.getElementById("countMods").textContent = mods.length + " clases";

      const box = document.getElementById("modules");
      box.innerHTML = "";
      showError("");

      if (!mods.length){
        showError("Este curso no tiene m√≥dulos cargados en la hoja Modules.");
        return;
      }

      mods.forEach((m, idx) => {
        const title = pickModuleTitle_(m);
        const order = pickModuleOrder_(m, idx);
        const videoId = pickVideoId_(m);

        const thumb = videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : "icons/icon-192.png";

        const b = document.createElement("button");
        b.className = "mod";
        b.innerHTML = `
          <div class="thumb"><img src="${thumb}" alt=""></div>
          <div class="info">
            <p class="t">${escapeHtml_(`${order}. ${title || "Clase"}`)}</p>
            <p class="s">Toca para reproducir</p>
          </div>
        `;

        b.onclick = () => {
          setActive(b);
          loadVideoById_(videoId, false);
          document.getElementById("nowPlaying").textContent = "Reproduciendo: " + (title || "Clase");
          const nt = document.getElementById("nowTitle"); if (nt) nt.textContent = (title || "Reproduciendo");
        };

        box.appendChild(b);
      });

      // Opcional: selecciona la primera clase
      // box.querySelector(".mod")?.click();
    })().catch(err => {
      showError(err.message || String(err));
    });
  </script>

  <script>
    // Dropdown + email
    (function(){
      const token = sessionStorage.getItem("pasir_token");
      const userMenu = document.getElementById("userMenu");
      const userTrigger = document.getElementById("userTrigger");
      const userDropdown = document.getElementById("userDropdown");
      const userNameEl = document.getElementById("userName");

      function closeMenu(){
        if (!userDropdown) return;
        userDropdown.classList.remove("open");
        if (userTrigger) userTrigger.setAttribute("aria-expanded","false");
      }
      function openMenu(){
        if (!userDropdown) return;
        userDropdown.classList.add("open");
        if (userTrigger) userTrigger.setAttribute("aria-expanded","true");
      }
      if (userTrigger && userDropdown){
        userTrigger.addEventListener("click", (e)=>{
          e.stopPropagation();
          userDropdown.classList.contains("open") ? closeMenu() : openMenu();
        });
        document.addEventListener("click", ()=> closeMenu());
        document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeMenu(); });
        userDropdown.addEventListener("click", (e)=> e.stopPropagation());
      }

      if (token && userMenu) userMenu.style.display = "inline-block";

      async function hydrateUser(){
        const storedEmail = sessionStorage.getItem("pasir_email");
        if (storedEmail && userNameEl) userNameEl.textContent = storedEmail;
        if (!token) return;
        try{
          const r = await jsonp("me", { token });
          if (!r.ok) return;
          const email =
            (r.user && (r.user.email || r.user.correo)) ||
            r.email ||
            sessionStorage.getItem("pasir_email") ||
            "‚Äî";

          if (userNameEl) userNameEl.textContent = email;
          sessionStorage.setItem("pasir_email", email);
          if (userMenu) userMenu.style.display = "inline-block";
        }catch(e){}
      }
      hydrateUser();

      const logoutBtn = document.getElementById("logout");
      if (logoutBtn){
        logoutBtn.addEventListener("click", (e)=>{
          e.preventDefault();
          sessionStorage.removeItem("pasir_token");
          sessionStorage.removeItem("pasir_email");
          sessionStorage.removeItem("pasir_name");
          location.href = "index.html";
        });
      }
    })();
  </script>

  <script>
    // Mostrar controles al tocar el video
    (function(){
      const shield = document.getElementById("tapShield");
      const wrap = document.getElementById("ccWrap");
      let hideTimer = null;

      function showControls(){
        if (!wrap) return;
        wrap.classList.add("is-visible");
        if (hideTimer) clearTimeout(hideTimer);
        hideTimer = setTimeout(() => wrap.classList.remove("is-visible"), 3200);
      }

      if (shield){
        shield.addEventListener("click", (e) => { e.preventDefault(); e.stopPropagation(); showControls(); }, {passive:false});
        shield.addEventListener("touchstart", (e) => { e.preventDefault(); e.stopPropagation(); showControls(); }, {passive:false});
      }

      if (wrap){
        wrap.addEventListener("pointerdown", () => { if (hideTimer) clearTimeout(hideTimer); });
        wrap.addEventListener("pointerup", () => { showControls(); });
      }
    })();
  </script>
</body>
</html>
